#!/bin/bash

if [ -z "$2" ]; then
	echo usage: $0 username domainname
	echo -domainname includes the .com/net/org
	exit
fi
USER=$1
DOMAIN=$2

#create a user if they dont exist
USER_NOEXIST=`finger $USER|grep "no such user."`
if [ -n "$USER_NOEXIST" ]; then
	#if they dont exist but have a home directory, move it
	if [ -d "/home/$USER" ]; then
		mv /home/$USER /home/tmp$USER
	fi
	useradd -d /home/$USER $USER	

	#clean up
	if [ -d "/home/tmp$USER" ]; then
		mv /home/tmp$USER/* /home/$USER/.
		rmdir /home/tmp$USER
	fi
fi

#create the directories if needed
if [ ! -d "/home/$USER" ]; then
	mkdir /home/$USER
fi

if [ ! -d "/home/$USER/www" ]; then
	mkdir /home/$USER/www
fi

if [ ! -d "/home/$USER/www/$DOMAIN" ]; then
	mkdir /home/$USER/www/$DOMAIN
fi

if [ ! -d "/home/$USER/www/$DOMAIN/htdocs" ]; then
	mkdir /home/$USER/www/$DOMAIN/htdocs
fi

if [ ! -d "/home/$USER/www/$DOMAIN/html" ]; then
	ln -s /home/$USER/www/$DOMAIN/htdocs /home/$USER/www/$DOMAIN/html
fi

if [ ! -d "/home/$USER/www/$DOMAIN/logs" ]; then
	mkdir /home/$USER/www/$DOMAIN/logs
fi



#set permissions and ownership
chown -R $USER /home/$USER
chmod -R 755 /home/$USER/www
chown $USER:www-data /home/$USER/www
chmod 711 /home/$USER

#add the vhosts creation + symlinking and apache cycle
echo "#
#   $DOMAIN (/etc/httpd/sites-available/$DOMAIN.conf)
#
<VirtualHost *:80>
        ServerAdmin admin@$DOMAIN
        ServerName $DOMAIN
        ServerAlias www.$DOMAIN *.$DOMAIN

        #Indexes + Directory Root
        DocumentRoot /home/$USER/www/$DOMAIN/htdocs/

        <Directory \"/home/$USER/www/$DOMAIN/html\">
                Options Indexes FollowSymLinks MultiViews
                AllowOverride All
                Order allow,deny
                Allow from all
        </Directory>

        #LOG FILES
        ErrorLog  /home/$USER/www/$DOMAIN/logs/error.log
        CustomLog /home/$USER/www/$DOMAIN/logs/access.log combined
</VirtualHost>" > /etc/httpd/sites-available/$DOMAIN.conf

ln -s /etc/httpd/sites-available/$DOMAIN.conf /etc/httpd/sites-enabled/$DOMAIN.conf
/etc/init.d/httpd reload

#add in DNS information
SERIAL= `date +%Y%m%d%M`
echo "\$TTL 3d
@       IN      SOA     $DOMAIN.       admin.twohlix.com (
                        $SERIAL         ; serial #
                        4H              ; refresh
                        1H              ; retry
                        1W              ; expiry
                        1D )            ; minimum
        IN      NS      ns1.twohlix.com.
        IN      NS      ns2.twohlix.com.

$DOMAIN. IN A 184.172.129.159
www.$DOMAIN. IN CNAME $DOMAIN.


localhost.$DOMAIN. IN A 127.0.0.1" > /var/named/$DOMAIN
ln -s /var/named/$DOMAIN /var/named/$DOMAIN.hosts

#maybe add the domain to the named.conf
NOAPPEND=`grep -w \"$DOMAIN\" /etc/named.conf`
if [ -z "$NOAPPEND" ]; then
 echo "adding $DOMAIN to /etc/named.conf"

 echo "zone \"$DOMAIN\" {
        type master;
        notify no;
        allow-query { any; };
        file \"/var/named/$DOMAIN.hosts\";
};" >> /etc/named.conf
else
 echo "$DOMAIN already found in /etc/named.conf, NOT adding it"
fi

/etc/init.d/named restart

